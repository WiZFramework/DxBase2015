<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link href="css/main.css" rel="stylesheet" type="text/css">
<title>DxBase2015ドキュメント(2015年)</title>
</head>
<body>
<!-- 全体コンテナ　-->
<div id="container">
<div id="header">
<h2>５．アルゴリズム研究</h2>
</div>
<!-- コンテンツ　-->
<div id="contents">
<br/>
<h3>５０３．テンプレートを使った、ストラテジーの代替</h3>
<br />
<h4>テンプレートを使う</h4>
　前項では、<b>ストラテジー</b>による計算クラスの作成方法を紹介しました。<br />
　しかし、C++で組む場合、<b>template</b>という機能があり、こちらを使った方がよりすっきりした記述で<b>計算クラス</b>を作成できます。<br />
　このことは、<b>デザインパターンの教科書（通称GoF）</b>にも指摘されています。<br />
　<b>Sample503</b>では<b>Sample502</b>と同じ実装を<b>template</b>を使って実装します。<br />
　まず計算クラスですが、前項では階層化されたクラスを使いましたが、この項ではテンプレートを使います。<br />
　<b>Sample503</b>を起動して、<b>Charactor.h</b>を見てください。
<div class="box1">
<pre>
    //--------------------------------------------------------------------------------------
    //  template&lt;typename T>
    //  class Jump
    //  用途: ジャンプの計算を返す関数オブジェクトテンプレート
    //--------------------------------------------------------------------------------------
    template&lt;typename T>
    class Jump{
        T m_T;
    public:
        <span class="red">float operator()(){
            return m_T();
        }</span>
    };

    //--------------------------------------------------------------------------------------
    //  class ShortType;
    //  用途: ショートジャンプの計算を返す関数オブジェクト
    //--------------------------------------------------------------------------------------
    class ShortType{
    public:
        <span class="red">float operator()(){
            return 2.0f;
        }</span>
    };
    //--------------------------------------------------------------------------------------
    //  class MediumType;
    //  用途: ミディアムジャンプの計算を返す関数オブジェクト
    //--------------------------------------------------------------------------------------
    class MediumType{
    public:
        <span class="red">float operator()(){
            return 4.0f;
        }</span>
    };
    //--------------------------------------------------------------------------------------
    //  class class LongType;
    //  用途: ロングジャンプの計算を返す関数オブジェクト
    //--------------------------------------------------------------------------------------
    class LongType{
    public:
        <span class="red">float operator()(){
            return 6.0f;
        }</span>
    };
    //--------------------------------------------------------------------------------------
    //  class LongLongType;
    //  用途: ロングロングジャンプの計算を返す関数オブジェクト
    //--------------------------------------------------------------------------------------
    class LongLongType{
    public:
        <span class="red">float operator()(){
            return 8.0f;
        }</span>
    };

</pre>
</div>
　ここでは、1つのテンプレートクラスと、それぞれ独立したクラス（他のクラスと何も継承も行っていない）4つのクラスで構成されています。<br />
　テンプレートクラスでは、内部に<b>T m_T</b>を持ちます。これは、テンプレートで<b>T型</b>のクラスが構築されたときに、そのインスタンスが、メンバ変数として自動的に構築されます。<br />
　それで、そのテンプレートクラスが作成したインスタンスの、<b>oparator()</b>が呼び出されたときに、<b>T m_T</b>に定義されている<b>m_T.();</b>を呼び出し（operator()呼び出し）、そのリターン値を返します。ただそれだけです。<br />
<br />
　実際にこのテンプレートを使ってクラスのインスタンスを構築しているのは、以下の部分です。<br />
　前項のように、<b>BoxのUpdate()関数</b>を見てみましょう。<br/>
<div class="box1">
<pre>
    void Box::Update(){
        //コントローラの取得
        auto CntlVec = App::GetApp()->GetInputDevice().GetControlerVec();
        if (CntlVec[0].bConnected){
            auto PtrGravity = GetComponent&lt;Gravity>();
            if (PtrGravity->GetGravityVelocity().Length() &lt;= 0){
                //地面にいるときのみジャンプできる
                //Aボタンが押された瞬間なら小ジャンプ
                if (CntlVec[0].wPressedButtons & XINPUT_GAMEPAD_A){
                    //ジャンプはショートタイプ
                    <span class="red">Jump&lt;ShortType> j;</span>
                    PtrGravity->StartJump(0, <span class="red">j()</span>, 0);
                }
                //Bボタンが押された瞬間なら中ジャンプ
                else if (CntlVec[0].wPressedButtons & XINPUT_GAMEPAD_B){
                    //ジャンプはミディアムタイプ
                    <span class="red">Jump&lt;MediumType> j;</span>
                    PtrGravity->StartJump(0, <span class="red">j()</span>, 0);
                }
                //Yボタンが押された瞬間なら大ジャンプ
                else if (CntlVec[0].wPressedButtons & XINPUT_GAMEPAD_Y){
                    //ジャンプはロングタイプ
                    <span class="red">Jump&lt;LongType> j;</span>
                    PtrGravity->StartJump(0, <span class="red">j()</span>, 0);
                }
                //Xボタンが押された瞬間なら大大ジャンプ
                else if (CntlVec[0].wPressedButtons & XINPUT_GAMEPAD_X){
                    //ジャンプはロングロングタイプ
                    <span class="red">Jump&lt;LongLongType> j;</span>
                    PtrGravity->StartJump(0, <span class="red">j()</span>, 0);
                }
            }
        }
    }
</pre>
</div>
　<b>template</b>はコンパイル時に評価されます。ですので
<div class="box1">
<pre>
    <span class="red">Jump&lt;ShortType> j;</span>
</pre>
</div>
　の実装で、<b>ShortTypeクラスにはfloat operator()があるかどうか</b>が検証され、持ってれば、そこにインスタンスを構築するように、コンパイラがコードを生成します。<br />
　そのあとは、
<div class="box1">
<pre>
<span class="red">j();</span>
</pre>
</div>
　の呼び出しで、その結果を使用します。<br />
　極端な話、<b>floatを返すoperator()があれば、どんなクラスでも計算に使用できる</b>ということになります。<br />
<br />
　計算するクラスなので、何らかの引数がほしい場合、たとえば、int型を引数に取る場合、テンプレートは
<div class="box1">
<pre>
    //--------------------------------------------------------------------------------------
    //  template&lt;typename T>
    //  class Jump
    //  用途: ジャンプの計算を返す関数オブジェクトテンプレート
    //--------------------------------------------------------------------------------------
    template&lt;typename T>
    class Jump{
        T m_T;
    public:
        <span class="red">float operator()(int i){
            return m_T(i);
        }</span>
    };
    //--------------------------------------------------------------------------------------
    //  class ShortType;
    //  用途: ショートジャンプの計算を返す関数オブジェクト
    //--------------------------------------------------------------------------------------
    class ShortType{
        float func(int i);
    public:
        <span class="red">float operator()(int i){
            //iを使って何らかの計算
            return  func(i);
        }</span>
    };

//.....

</pre>
</div>
　のような形になり、呼び出すときは
<div class="box1">
<pre>
    <span class="red">Jump&lt;ShortType> j;</span>
    PtrGravity->StartJump(0, <span class="red">j(3)</span>, 0);
</pre>
</div>
　のような形になるでしょう。<br />
<br />
</div>
<!-- /コンテンツ　-->
<hr>
<!-- フッタ　-->
<ul class="foot_navi">
<li><a href="50_02.html">前ページ</a></li>
<li><a href="index.html">目次</a></li>
<li><a href="50_04.html">次ページ</a></li>
</ul>
<!-- /フッタ　-->


</div>
<!-- /全体コンテナ　-->
</body>
</html>
