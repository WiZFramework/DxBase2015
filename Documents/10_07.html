<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Trからのぷろansitional//EN">
<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link href="css/main.css" rel="stylesheet" type="text/css">
<title>DxBase2015ドキュメント(2015年)</title>
</head>
<body>
<!-- 全体コンテナ　-->
<div id="container">
<div id="header">
<h2>１．更新補助</h2>
</div>
<!-- コンテンツ　-->
<div id="contents">
<br/>
<h3>１０７．ステートマシンをライブラリから独立させる（別エンジンで実装する場合などの指針）</h3>
<h4>ステートの親テンプレートクラスとステートマシンクラス</h4>
　<b>DxBase2015フレームワーク</b>で使用している<b>ステートとステートマシン</b>は、<b>ステートについては親テンプレートクラス</b>があり、<b>ステートマシンについてはテンプレートクラス</b>になっています。<br />
　<b>GameObjectクラスでなければ使用できない</b>といったものではないので、<b>他のC++フレームワークやフレームワークなしで0から組んでる場合</b>でも使用できます。<br />
　以下に、ステートの親テンプレートクラスである<b>ObjState</b>と、ステートマシンテンプレートクラスである<b>StateMachine</b>の全ソースを紹介しますので、このままどこかのヘッダファイルにコピーすれば、<b>DxBase2015フレームワーク</b>のように、<b>ステートとステートマシン</b>を使えるようになります。<br />
　ただし、スマートポインタを使っているので、<b>C++11がコンパイルできる環境</b>であることが必要です。<br/>
　また、そのフレームワーク独自の仕様で、使えない場合もありますので、ご注意ください。以下、ソースを見てもらうとわかりますが、<b>DxBase2015フレームワークでなければ使用できないような記述</b>はされておりません。
<div class="box1">
<pre>

    #include &lt;memory>

    template &lt;typename T>
    class StateMachine;

    //--------------------------------------------------------------------------------------
    //  class ObjState;
    //  用途: ステート実装テンプレートクラス(抽象クラス)
    //--------------------------------------------------------------------------------------
    template &lt;typename T>
    class ObjState{
    public:
        //--------------------------------------------------------------------------------------
        //  ObjState();
        //  用途: コンストラクタ
        //  戻り値: なし
        //--------------------------------------------------------------------------------------
        ObjState(){}
        //--------------------------------------------------------------------------------------
        //  virtual ~ObjState();
        //  用途: デストラクタ
        //  戻り値: なし
        //--------------------------------------------------------------------------------------
        virtual ~ObjState(){}
        //--------------------------------------------------------------------------------------
        //  virtual void Enter(
        //  const shared_ptr&lt;T>& Obj     //ステートを保持するオブジェクト
        //  ) = 0;
        //  用途: ステートに入ったときに実行される
        //  戻り値: なし（純粋仮想関数）
        //--------------------------------------------------------------------------------------
        virtual void Enter(const shared_ptr&lt;T>& Obj) = 0;
        //--------------------------------------------------------------------------------------
        //  virtual void Execute(
        //  const shared_ptr&lt;T>& Obj     //ステートを保持するオブジェクト
        //  ) = 0;
        //  用途: Updateのときに実行される
        //  戻り値: なし（純粋仮想関数）
        //--------------------------------------------------------------------------------------
        virtual void Execute(const shared_ptr&lt;T>& Obj) = 0;
        //--------------------------------------------------------------------------------------
        //  virtual void Exit(
        //  const shared_ptr&lt;T>& Obj     //ステートを保持するオブジェクト
        //  ) = 0;
        //  用途: ステートを出るときに実行される
        //  戻り値: なし（純粋仮想関数）
        //--------------------------------------------------------------------------------------
        virtual void Exit(const shared_ptr&lt;T>& Obj) = 0;
    };

    //--------------------------------------------------------------------------------------
    //  template &lt;typename T>
    //  class StateMachine;
    //  用途: ステートマシン実装テンプレートクラス
    //  ＊ステートを管理する
    //--------------------------------------------------------------------------------------
    template &lt;typename T>
    class StateMachine
    {
    private:
        //このステートマシンを持つオーナー
        weak_ptr&lt;T> m_Owner;
        //現在のステート
        weak_ptr&lt; ObjState&lt;T> > m_CurrentState;
        //一つ前のステート
        weak_ptr&lt; ObjState&lt;T> > m_PreviousState;
    public:
        //--------------------------------------------------------------------------------------
        //  StateMachine(
        //  const shared_ptr&lt;T>& owner   //このステートマシンを保持するオーナー
        //  );
        //  用途: コンストラクタ
        //  戻り値: なし
        //--------------------------------------------------------------------------------------
        explicit StateMachine(const shared_ptr&lt;T>& owner) :
            m_Owner(owner)
        {}
        //--------------------------------------------------------------------------------------
        //  virtual ~StateMachine();
        //  用途: デストラクタ
        //  戻り値: なし
        //--------------------------------------------------------------------------------------
        virtual ~StateMachine(){}
        //--------------------------------------------------------------------------------------
        //  用途: Setアクセッサ
        //  戻り値: なし
        //--------------------------------------------------------------------------------------
        void SetCurrentState(const shared_ptr&lt; ObjState&lt;T> >& s){ m_CurrentState = s; }
        void SetPreviousState(const shared_ptr&lt; ObjState&lt;T> >& s){ m_PreviousState = s; }
        //--------------------------------------------------------------------------------------
        //  用途: Getアクセッサ
        //  戻り値: ObjState&lt;T>*
        //--------------------------------------------------------------------------------------
        shared_ptr&lt; ObjState&lt;T> >  GetCurrentState() const {
            if (!m_CurrentState.expired()){
                return m_CurrentState.lock();
            }
            return nullptr; 
        }
        shared_ptr&lt; ObjState&lt;T> >  GetPreviousState()const {
            if (!m_pPreviousState.expired()){
                return m_pPreviousState.lock();
            }
            return nullptr;
        }
        //--------------------------------------------------------------------------------------
        //  void  Update() const
        //  用途: ステートを更新する
        //  戻り値: なし
        //  ＊メンバは変更しないのでconst関数で問題ない
        //--------------------------------------------------------------------------------------
        void Update() const{
            if (!m_CurrentState.expired() && !m_Owner.expired()){
                auto Ptr = m_CurrentState.lock();
                Ptr->Execute(m_Owner.lock());
            }
        }
        //--------------------------------------------------------------------------------------
        //  void  ChangeState(
        //  const shared_ptr&lt; ObjState&lt;T> >& NewState //新しいステート
        //　);
        // 用途: ステートを変更する
        // 戻り値: なし
        //--------------------------------------------------------------------------------------
        void  ChangeState(const shared_ptr&lt; ObjState&lt;T> >& NewState){
            //元のステートを保存
            m_PreviousState = m_CurrentState;
            if (!m_CurrentState.expired() && !m_Owner.expired()){
                //元のステートに終了を知らせる
                auto Ptr = m_CurrentState.lock();
                Ptr->Exit(m_Owner.lock());
            }
            //新しいステートをカレントに設定
            m_CurrentState = NewState;
            if (!m_CurrentState.expired() && !m_Owner.expired()){
                //元のステートに終了を知らせる
                auto Ptr = m_CurrentState.lock();
                Ptr->Enter(m_Owner.lock());
            }
        }
        //--------------------------------------------------------------------------------------
        //  void RevertToPreviousState();
        // 用途: ステートを一つ前のステートに戻す
        // 戻り値: なし
        //--------------------------------------------------------------------------------------
        void RevertToPreviousState(){
            ChangeState(m_pPreviousState);
        }
        //--------------------------------------------------------------------------------------
        //bool IsInState(
        //const ObjState&lt;T>& st  //調べるステート
        //)const;
        //用途: カレントステートが指定したステートになってるかどうかをチェック
        //戻り値: なし
        //--------------------------------------------------------------------------------------
        bool IsInState(const shared_ptr&lt; ObjState&lt;T> >& st)const{
            if (m_CurrentState.expired()){
                return false;
            }
            return typeid(m_CurrentState.lock()) == typeid(st);
        }
    };
</pre>
</div>
<br/>
　なお、<b>サンプル107</b>では、ライブラリに含まれてる<b>ステートとステートマシン</b>を使うのではなく、サンプル独自の<b>ステートとステートマシン</b>として<b>MyObjeStateとMyStateMachine</b>というのを宣言し、それをプレイヤーで使用しています。<br />
　意味合い的には、上記ソースを別フレームワークで使用するのと同じです。<br />
<br />
</div>
<!-- /コンテンツ　-->
<hr>
<!-- フッタ　-->
<ul class="foot_navi">
<li><a href="10_06.html">前ページ</a></li>
<li><a href="index.html">目次</a></li>
<li><a href="10_08.html">次ページ</a></li>
</ul>
<!-- /フッタ　-->


</div>
<!-- /全体コンテナ　-->
</body>
</html>
